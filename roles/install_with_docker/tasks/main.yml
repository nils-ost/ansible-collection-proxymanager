---
- name: create compose directory
  ansible.builtin.file:
    path: "{{ proxymanager_compose_dir }}"
    state: directory
    mode: "0755"
  register: compose_dir

- name: write compose file
  ansible.builtin.template:
    src: templates/docker-compose.yml.j2
    dest: "{{ [proxymanager_compose_dir, 'docker-compose.yml'] | path_join }}"
    owner: root
    group: root
    mode: "0644"
  register: compose_file

- name: stop compose service
  community.docker.docker_compose_v2:
    project_src: "{{ proxymanager_compose_dir }}"
    remove_orphans: true
    state: stopped
    timeout: 11
  when: compose_file.changed and not compose_dir.results[0].changed

- name: start compose service
  community.docker.docker_compose_v2:
    project_src: "{{ proxymanager_compose_dir }}"
    remove_orphans: true
    pull: "{{ proxymanager_auto_upgrade | ternary('always', 'missing') }}"
    state: present
    wait: true
    wait_timeout: 10
  register: compose_start

- name: wait for proxymanager to be reachable
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: "81"
    timeout: 30
    connect_timeout: 2
    sleep: 2
    delay: 10
  when: compose_start.changed

- name: fetch API token
  nils_ost.proxymanager.token:
    host: "{{ ansible_host }}"
    user: "{{ proxymanager_user_email }}"
    password: "{{ proxymanager_user_password }}"
  delegate_to: localhost
  register: npm

- name: create certificate
  nils_ost.proxymanager.certificate:
    url: "{{ npm.url }}"
    token: "{{ npm.token }}"
    domain_name: "{{ proxymanager_cert_domain }}"
    provider: "domainoffensive"
    provider_credentials: "{{ proxymanager_do_de_token }}"
    state: present
  delegate_to: localhost
  register: cert
  when: proxymanager_cert_domain != None

- name: remove deprecated proxys
  nils_ost.proxymanager.proxy:
    url: "{{ npm.url }}"
    token: "{{ npm.token }}"
    domain_name: "{{ item }}"
    state: absent
  delegate_to: localhost
  loop: "{{ (proxymanager_remove_proxys == None) | ternary([], proxymanager_remove_proxys) }}"

- name: remove deprecated redirections
  nils_ost.proxymanager.redirection:
    url: "{{ npm.url }}"
    token: "{{ npm.token }}"
    domain_name: "{{ item }}"
    state: absent
  delegate_to: localhost
  loop: "{{ (proxymanager_remove_redirections == None) | ternary([], proxymanager_remove_redirections) }}"

- name: create custom proxys
  nils_ost.proxymanager.proxy:
    url: "{{ npm.url }}"
    token: "{{ npm.token }}"
    domain_name: "{{ item.key }}"
    forward_host: "{{ item.value.host }}"
    forward_port: "{{ item.value.port }}"
    certificate_id: "{{ (proxymanager_cert_domain == None) | ternary(0, cert.item.id) }}"
    state: present
  delegate_to: localhost
  loop: "{{ (proxymanager_custom_proxys == None) | ternary(dict(), proxymanager_custom_proxys) | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: create custom redirections
  nils_ost.proxymanager.redirection:
    url: "{{ npm.url }}"
    token: "{{ npm.token }}"
    domain_name: "{{ item.key }}"
    forward_host: "{{ item.value.dest }}"
    forward_scheme: "{{ item.value.scheme }}"
    certificate_id: "{{ (proxymanager_cert_domain == None) | ternary(0, cert.item.id) }}"
    state: present
  delegate_to: localhost
  loop: "{{ (proxymanager_custom_redirections == None) | ternary(dict(), proxymanager_custom_redirections) | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
